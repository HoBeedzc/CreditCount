//获取url中的参数 参考自：https://www.cnblogs.com/babycool/p/3169058.html
function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
    var r = window.location.search.substr(1).match(reg);  //匹配目标参数
    if (r != null) return unescape(r[2]); return "None"; //返回参数值
}

function submitForm() {
    var major = $("#major-selecter").val();
    var grade = $("#grade-selecter").val();
    const params = new URLSearchParams();
    params.set('major', encodeURIComponent(major));       // 设置参数
    params.set('grade', grade);       // 支持 Boolean、Number 等丰富类型
    window.location.href = '/?' + params.toString();
}

function getTotalCount() {
    var my_major = $("#major-selecter").val();
    var item = this.parentNode.parentNode.parentNode;
    var checked = $(this).is(':checked');
    var count = parseFloat(item.getElementsByClassName('cc-course-credit')[0].innerHTML);
    var total = parseFloat(document.getElementsByClassName('cc-credit-total')[0].innerHTML);
    var course_major = $(item).children('.cc-course-major').text().split('|');
    var course_list_item = $("#left-courses-list-item-template").clone();

    if (my_major == "None") {
        alert("请选择您的预计准出专业！");
        if (checked) {
            $(this).prop('checked', false);
        } else {
            $(this).prop('checked', true);
        }
        return;
    }

    if (checked) {
        if (course_major[0] == "一般专业类") {
            $('.cc-credit-general').html(parseFloat($('.cc-credit-general').html()) + count);
            $('.cc-credit-total').each(function () {
                $(this).html(parseFloat($(this).html()) + count);
            });
            $('.cc-credit-remain').each(function () {
                $(this).html(25 - total - count);
            });
        } else if (course_major.indexOf(my_major) != -1) {
            $('.cc-credit-core-major').html(parseFloat($('.cc-credit-core-major').html()) + count);
        } else {
            $('.cc-credit-core-other').html(parseFloat($('.cc-credit-core-other').html()) + count);
            $('.cc-credit-total').each(function () {
                $(this).html(parseFloat($(this).html()) + count);
            });
            $('.cc-credit-remain').each(function () {
                $(this).html(25 - total - count);
            });
        }
        $(item).addClass('positive');
        course_list_item.find('.cc-course-name').html($(item).find('.cc-course-name').html());
        course_list_item.find('.cc-course-major').html(course_major[0] == "一般专业类" ? "一般专业类" : "核心专业类");
        course_list_item.find('.cc-course-credit').html($(item).find('.cc-course-credit').html());
        course_list_item.find('.cc-course-grade').html($(item).find('.cc-course-grade').html());
        course_list_item.find('.cc-course-term').html($(item).find('.cc-course-term').html());
        $("#left-courses-list-item-template").after(course_list_item);
        course_list_item.toggle();
    } else {
        if (course_major[0] == "一般专业类") {
            $('.cc-credit-general').html(parseFloat($('.cc-credit-general').html()) - count);
            $('.cc-credit-total').each(function () {
                $(this).html(parseFloat($(this).html()) - count);
            });
            $('.cc-credit-remain').each(function () {
                $(this).html(25 - total + count);
            });
        } else if (course_major.indexOf(my_major) != -1) {
            $('.cc-credit-core-major').html(parseFloat($('.cc-credit-core-major').html()) - count);
        } else {
            $('.cc-credit-core-other').html(parseFloat($('.cc-credit-core-other').html()) - count);
            $('.cc-credit-total').each(function () {
                $(this).html(parseFloat($(this).html()) - count);
            });
            $('.cc-credit-remain').each(function () {
                $(this).html(25 - total + count);
            });
        }
        $(item).removeClass('positive');
        $("#course-list").find(".cc-course-name:contains('" + $(item).find('.cc-course-name').html() + "')").parent().parent().parent().remove();
    }
}


function closeMessageBox() {
    $(this).parent().toggle();
}

function test() {
    return "test";
}

function initCredits() {
    var major = getUrlParam('major');
    var grade = getUrlParam('grade');

    $('.cc-credit-core-major').html('0');
    $('.cc-credit-core-other').html('0');
    $('.cc-credit-general').html('0');
    $('.cc-credit-total').html('0');
    $('.cc-credit-remain').html('25');
    $("#major-selecter").val(decodeURIComponent(major));
    $("#grade-selecter").val(grade);
}

$(document).ready(function () {
    test();
    initCredits();
    $('.cc-course-checkbox').change(getTotalCount);
    $('.close').click(closeMessageBox);
});